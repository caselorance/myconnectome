---
title: "Timeseries analyses for MyConnectome Project"
author: "Russ Poldrack"
date: "November 1, 2014"
output: html_document
---

This notebook runs all of the timeseries analyses presented in the MyConnectome paper. Note that this set of analyses will take a good bit of time to run (> 15 mins on a laptop).

First we need to load some relevant libraries:

```{r message=FALSE}
library(forecast)
library(knitr)
source('http://s3.amazonaws.com/openfmri/ds031/timeseries_analyses/load_myconnectome_data.R')
#source('http://s3.amazonaws.com/openfmri/ds031/timeseries_analyses/est_bivariate_arima_model.R')
source('est_bivariate_arima_model.R')


```

If you would like your results to be put into a specific place, then set the variable OUTPUT_DIR to that value.  This puts them in a specific place on my computer.

```{r}

if (file.exists('/Users/poldrack/Dropbox/data/selftracking/timeseries_analyses')) {
  print("Looks like we are on Russ's computer, using default OUTPUT_DIR")
	OUTPUT_DIR='/Users/poldrack/Dropbox/data/selftracking/timeseries_analyses'
}

if (!exists('OUTPUT_DIR')) {
	print('To save results to a specific directory, set OUTPUT_DIR variable to target directory')
	OUTPUT_DIR=NULL 
} else{
	print(c('Saving results to:',OUTPUT_DIR))
}
	
if (is.null(OUTPUT_DIR)) {
	OUTPUT_DIR='timeseries_results'
	print('creating output directory: ./timeseries_results')
	dir.create(OUTPUT_DIR)
	}

```


Load all of the relevant data

```{r message=FALSE,warning=FALSE,error=FALSE}
behav=load_behav_data()
wincorr=load_fmri_data('wincorr')
fd=load_fd_data()
food=load_food_data()
rnaseq_wgcna=load_rnaseq_data(limit_ME_to_enriched=TRUE)
metab=load_metab_data()
immport=load_ImmPort_data()

```

Create the subset of data that we are interested in for the behavioral analysis - generate a version without the tuesday/thursday variable for use with the blood data (which are only on tuesdays)

```{r}
xvars=c('panas.positive','panas.negative','panas.fatigue','afterscan.Anxietyduringscan','afterscan.diastolic','afterscan.pulse','afterscan.systolic','morning.Sleepquality','morning.Soreness','prevevening.Alcohol','prevevening.Guthealth','prevevening.Psoriasisseverity','prevevening.Stress', 'prevevening.Timespentoutdoors','tu_th', 'temp.mean',"email.LIWC_CDI","email.LIWC_negemo","email.LIWC_posemo",'zeo.zq')

behav_keep=subset(behav,select=c(xvars,'date'))
behav_keep_no_tth=subset(behav_keep,select=-tu_th)
```

## Run regression models
For each set of variables, run the regression model and save outputs.


First set our FDR threshold:
```{r}
fdr_thresh=0.1
```

####Behavioral variables vs. each other:
out.dat.behav_behav=read.table(paste(OUTPUT_DIR,'out.dat.behav_behav.txt',sep='/'))


```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.behav_behav=est_bivariate_arima_model(behav_keep, behav_keep,spacing='1 day',skip_ident=TRUE)

```

```{r  results="asis"}
kable(out.dat.behav_behav[out.dat.behav_behav$pval_bh<fdr_thresh,])
write.table(out.dat.behav_behav,file=paste(OUTPUT_DIR,'out.dat.behav_behav.txt',sep='/'))
```

####Within-module connectivity vs. behavior

```{r message=FALSE,warning=FALSE,error=FALSE}
out.dat.wincorr_behav=est_bivariate_arima_model(wincorr,behav_keep)
```

```{r  results="asis"}
kable(out.dat.wincorr_behav[out.dat.wincorr_behav$pval_bh<fdr_thresh,])
write.table(out.dat.wincorr_behav,file=paste(OUTPUT_DIR,'out.dat.wincorr_behav.txt',sep='/'))
```

####Behavior vs. RNA-seq:


```{r message=FALSE,warning=FALSE,error=FALSE}
out.dat.wgcna_behav=est_bivariate_arima_model(rnaseq_wgcna,behav_keep_no_tth,spacing='1 week')
```


```{r  results="asis"}
kable(out.dat.wgcna_behav[out.dat.wgcna_behav$pval_bh<fdr_thresh,])
write.table(out.dat.wgcna_behav,file=paste(OUTPUT_DIR,'out.dat.wgcna_behav.txt',sep='/'))

```

#### Within-module connectivity vs. RNA-seq
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_wincorr=est_bivariate_arima_model(rnaseq_wgcna,wincorr,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.wgcna_wincorr[out.dat.wgcna_wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.wgcna_wincorr,file=paste(OUTPUT_DIR,'out.dat.wgcna_wincorr.txt',sep='/'))
```


####ImmPort immune genes vs behavior

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_behav=est_bivariate_arima_model(immport,behav_keep_no_tth,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.immport_behav[out.dat.immport_behav$pval_bh<fdr_thresh,])
write.table(out.dat.immport_behav,file=paste(OUTPUT_DIR,'out.dat.immport_behav.txt',sep='/'))
```

####ImmPort immune genes vs within-module connectivity

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_wincorr=est_bivariate_arima_model(immport,wincorr,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.immport_wincorr[out.dat.immport_wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.immport_wincorr,file=paste(OUTPUT_DIR,'out.dat.immport_wincorr.txt',sep='/'))
```

####ImmPort immune genes vs food
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_immport=est_bivariate_arima_model(food,immport,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.food_immport[out.dat.food_immport$pval_bh<fdr_thresh,])
write.table(out.dat.food_immport,file=paste(OUTPUT_DIR,'out.dat.food_immport.txt',sep='/'))
```

####ImmPort immune genes vs metabolism
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_metab=est_bivariate_arima_model(immport,metab,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.immport_metab[out.dat.immport_metab$pval_bh<fdr_thresh,])
write.table(out.dat.immport_metab,file=paste(OUTPUT_DIR,'out.dat.immport_metab.txt',sep='/'))
```


#### food vs. metabolism
note: food needs to be X variable because auto.arima doesn't handle binary Y variable
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_metab=est_bivariate_arima_model(food,metab,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.food_metab[out.dat.food_metab$pval_bh<fdr_thresh,])
write.table(out.dat.food_metab,file=paste(OUTPUT_DIR,'out.dat.food_metab.txt',sep='/'))
```

#### behav vs. metabolsm
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.behav_metab=est_bivariate_arima_model(behav_keep_no_tth,metab,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.behav_metab[out.dat.behav_metab$pval_bh<fdr_thresh,])
write.table(out.dat.behav_metab,file=paste(OUTPUT_DIR,'out.dat.behav_metab.txt',sep='/'))
```

####metabolism vs. within-network connectivity
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.metab_wincorr=est_bivariate_arima_model(metab,wincorr,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.metab_wincorr[out.dat.metab_wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.metab_wincorr,file=paste(OUTPUT_DIR,'out.dat.metab_wincorr.txt',sep='/'))
```



#### within-network connectivity 
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wincorr_wincorr=est_bivariate_arima_model(wincorr,wincorr,skip_ident=TRUE)
```

```{r  results="asis"}
kable(out.dat.wincorr_wincorr[out.dat.wincorr_wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.wincorr_wincorr,file=paste(OUTPUT_DIR,'out.dat.wincorr_wincorr.txt',sep='/'))
```



#### food vs. within-network connectivity
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_wincorr=est_bivariate_arima_model(food,wincorr)
```

```{r  results="asis"}
kable(out.dat.food_wincorr[out.dat.food_wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.food_wincorr,file=paste(OUTPUT_DIR,'out.dat.food_wincorr.txt',sep='/'))
```

#### food vs. behavior
Remove food variables that have too many zeros or ones, otherwise will fail

```{r message=FALSE,warning=FALSE,error=FALSE}
food$apples=NULL  
food$blueberries=NULL
behav_keep_no_tth$zeo.zq=NULL

out.dat.food_behav=est_bivariate_arima_model(food,behav_keep_no_tth)
```

```{r  results="asis"}
kable(out.dat.food_behav[out.dat.food_behav$pval_bh<fdr_thresh,])
write.table(out.dat.food_behav,file=paste(OUTPUT_DIR,'out.dat.food_behav.txt',sep='/'))
```

#### compare head motion to other measures
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.behav=est_bivariate_arima_model(fd,behav_keep)
```

```{r  results="asis"}
kable(out.dat.fd.behav[out.dat.fd.behav$pval_bh<fdr_thresh,])
write.table(out.dat.fd.behav,file=paste(OUTPUT_DIR,'out.dat.fd_behav.txt',sep='/'))
```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.rnaseq=est_bivariate_arima_model(fd,rnaseq_wgcna,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.fd.rnaseq[out.dat.fd.rnaseq$pval_bh<fdr_thresh,])

write.table(out.dat.fd.behav,file=paste(OUTPUT_DIR,'out.dat.fd_wgcna.txt',sep='/'))
```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.metab=est_bivariate_arima_model(fd,metab,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.fd.metab[out.dat.fd.metab$pval_bh<fdr_thresh,])
write.table(out.dat.fd.behav,file=paste(OUTPUT_DIR,'out.dat.fd_metab.txt',sep='/'))
```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.wincorr=est_bivariate_arima_model(fd,wincorr)
```

```{r  results="asis"}
kable(out.dat.fd.wincorr[out.dat.fd.wincorr$pval_bh<fdr_thresh,])
write.table(out.dat.fd.wincorr,file=paste(OUTPUT_DIR,'out.dat.fd_wincorr.txt',sep='/'))
```


#### RNA-seq 


```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_wgcna=est_bivariate_arima_model(rnaseq_wgcna, rnaseq_wgcna,spacing='1 week',skip_ident=TRUE)
```

```{r  results="asis"}
kable(out.dat.wgcna_wgcna[out.dat.wgcna_wgcna$pval_bh<fdr_thresh,])
write.table(out.dat.wgcna_wgcna,file=paste(OUTPUT_DIR,'out.dat.wgcna_wgcna.txt',sep='/'))
```

#### RNA-seq vs. metabolism
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_metab=est_bivariate_arima_model(rnaseq_wgcna,metab,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.wgcna_metab[out.dat.wgcna_metab$pval_bh<fdr_thresh,])
write.table(out.dat.wgcna_metab,file=paste(OUTPUT_DIR,'out.dat.wgcna_metab.txt',sep='/'))
```

#### RNA-seq vs. food


```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_food=est_bivariate_arima_model(food,rnaseq_wgcna,spacing='1 week')
```

```{r  results="asis"}
kable(out.dat.wgcna_food[out.dat.wgcna_food$pval_bh<fdr_thresh,])
write.table(out.dat.wgcna_food,file=paste(OUTPUT_DIR,'out.dat.food_wgcna.txt',sep='/'))
```

