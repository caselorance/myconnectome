---
title: "Timeseries analyses for MyConnectome Project"
author: "Russ Poldrack"
date: "November 1, 2014"
output: html_document
---

This notebook runs all of the timeseries analyses presented in the MyConnectome paper. Note that this set of analyses will take a good bit of time to run (> 15 mins on a laptop).

First we need to load some relevant libraries:

```{r message=FALSE}
library(forecast)
library(knitr)
source('http://s3.amazonaws.com/openfmri/ds031/timeseries_analyses/load_myconnectome_data.R')
source('http://s3.amazonaws.com/openfmri/ds031/timeseries_analyses/est_bivariate_arima_model.R')

save_latex=TRUE
```

Make a wrapper for kable that can detect empty datasets

```{r}
kable_wrap = function(data,fdr_thresh=0.1) {
  data = data[data$pval_bh<fdr_thresh,]
  if (nrow(data)>0) {kable(data)} else {print('no significant results')}
}


kable_latex = function(data,varname,tabledir='/Users/poldrack/Dropbox/Documents/Papers/SelfTracking/timeseries_analysis_tables') {
    if (nrow(data) > 30) {lt=TRUE} else {lt=FALSE}
    k=kable(data,format='latex',longtable=lt,digits=3,row.names=FALSE)
    write(k,file=sprintf('%s/%s_timeseries_stats.tex',tabledir,varname))
}

output_results=function(d,vnames,fdr_thresh=0.1,save_latex=TRUE,save_table=TRUE,OUTPUT_DIR='/tmp') {
  vname=sprintf('%s_%s',vnames[1],vnames[2])
  ds=d[d$pval_bh<fdr_thresh,]
  ds=subset(ds,select=c(xvar,yvar,cor.val,t.arima,pval_bh,nobs))
  names(ds)=c(sprintf("X:%s",vnames[1]),sprintf("Y:%s",vnames[2]),'r','t','p (BH)','N')
  if (save_table) {
    write.table(d,file=paste(OUTPUT_DIR,sprintf('out.dat.%s.txt',vname),sep='/'))
  }
  if (save_latex) {
    kable_latex(ds,vname)
  }
}
```
If you would like your results to be put into a specific place, then set the variable OUTPUT_DIR to that value.  This puts them in a specific place on my computer.

```{r}

if (file.exists('/Users/poldrack/Dropbox/data/selftracking/timeseries_analyses')) {
  print("Looks like we are on Russ's computer, using default OUTPUT_DIR")
	OUTPUT_DIR='/Users/poldrack/Dropbox/data/selftracking/timeseries_analyses'
}

if (!exists('OUTPUT_DIR')) {
	print('To save results to a specific directory, set OUTPUT_DIR variable to target directory')
	OUTPUT_DIR=NULL 
} else{
	print(c('Saving results to:',OUTPUT_DIR))
}
	
if (is.null(OUTPUT_DIR)) {
	OUTPUT_DIR='timeseries_results'
	print('creating output directory: ./timeseries_results')
	dir.create(OUTPUT_DIR)
	}

```


Load all of the relevant data

```{r message=FALSE,warning=FALSE,error=FALSE}
behav=load_behav_data()
wincorr=load_fmri_data('wincorr')
bwcorr=load_fmri_data('bwcorr')


fd=load_fd_data()
food=load_food_data()
rnaseq_wgcna=load_rnaseq_data(limit_ME_to_enriched=FALSE)
metab=load_metab_data()
data_names=c()
for (i in 1:(dim(metab)[2]-1)) {
    data_names=rbind(data_names,sprintf('C%d:%s',i,names(metab)[i]))
  	}
data_names=rbind(data_names,'date')
names(metab)=data_names


fullmetab=load_metab_data(use_clustered_data=FALSE)

immport=load_ImmPort_data()

```

Create the subset of data that we are interested in for the behavioral analysis - generate a version without the tuesday/thursday variable for use with the blood data (which are only on tuesdays)

```{r}
xvars=c('panas.positive','panas.negative','panas.fatigue','afterscan.Anxietyduringscan','afterscan.diastolic','afterscan.pulse','afterscan.systolic','morning.Sleepquality','morning.Soreness','prevevening.Alcohol','prevevening.Guthealth','prevevening.Psoriasisseverity','prevevening.Stress', 'prevevening.Timespentoutdoors','TuesThurs', 'temp.mean',"email.LIWCcdi","email.LIWCnegemo","email.LIWCposemo",'zeo.zq')

behav_keep=subset(behav,select=c(xvars,'date'))
behav_keep_no_tth=subset(behav_keep,select=-TuesThurs)
```

## Run regression models
For each set of variables, run the regression model and save outputs.


First set our FDR threshold:
```{r}
fdr_thresh=0.1
```

####Behavioral variables vs. each other:

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.behav_behav=est_bivariate_arima_model(behav_keep, behav_keep,spacing='1 day',skip_ident=TRUE)

```

```{r  results="asis"}
d=out.dat.behav_behav
vnames=c('behav','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####Within-module connectivity vs. behavior

```{r message=FALSE,warning=FALSE,error=FALSE}
out.dat.wincorr_behav=est_bivariate_arima_model(wincorr,behav_keep)
```

```{r  results="asis"}
d=out.dat.wincorr_behav
vnames=c('wincorr','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####Between-module connectivity vs. behavior

```{r message=FALSE,warning=FALSE,error=FALSE}
out.dat.bwcorr_behav=est_bivariate_arima_model(bwcorr,behav_keep)
```

```{r  results="asis"}
d=out.dat.bwcorr_behav
vnames=c('bwcorr','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```


####Behavior vs. RNA-seq:


```{r message=FALSE,warning=FALSE,error=FALSE}
out.dat.wgcna_behav=est_bivariate_arima_model(rnaseq_wgcna,behav_keep_no_tth,spacing='1 week')
```


```{r  results="asis"}
d=out.dat.wgcna_behav
vnames=c('wgcna','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)


```

#### Within-module connectivity vs. RNA-seq
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_wincorr=est_bivariate_arima_model(rnaseq_wgcna,wincorr,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.wgcna_wincorr
vnames=c('wgcna','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### Between-module connectivity vs. RNA-seq
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_bwcorr=est_bivariate_arima_model(rnaseq_wgcna,bwcorr,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.wgcna_bwcorr
vnames=c('wgcna','bwcorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```



####ImmPort immune genes vs behavior

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_behav=est_bivariate_arima_model(immport,behav_keep_no_tth,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.immport_behav
vnames=c('immport','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####ImmPort immune genes vs within-module connectivity

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_wincorr=est_bivariate_arima_model(immport,wincorr,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.immport_wincorr
vnames=c('immport','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####ImmPort immune genes vs food
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_immport=est_bivariate_arima_model(food,immport,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.food_immport
vnames=c('food','immport')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####ImmPort immune genes vs metabolism
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_metab=est_bivariate_arima_model(immport,metab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.immport_metab
vnames=c('immport','metab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####ImmPort immune genes vs metabolism (full set)
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.immport_fullmetab=est_bivariate_arima_model(immport,fullmetab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.immport_fullmetab
vnames=c('immport','fullmetab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```



#### food vs. metabolism
note: food needs to be X variable because auto.arima doesn't handle binary Y variable
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_metab=est_bivariate_arima_model(food,metab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.food_metab
vnames=c('food','metab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### food vs. metabolism (individual metabolites)
note: food needs to be X variable because auto.arima doesn't handle binary Y variable
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_fullmetab=est_bivariate_arima_model(food,fullmetab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.food_fullmetab
vnames=c('food','fullmetab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```


#### behav vs. metabolsm
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.behav_metab=est_bivariate_arima_model(behav_keep_no_tth,metab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.behav_metab
vnames=c('behav','metab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### behav vs. metabolsm (full set)
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.behav_fullmetab=est_bivariate_arima_model(behav_keep_no_tth,fullmetab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.behav_fullmetab
vnames=c('behav','fullmetab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```


####metabolism vs. within-network connectivity
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.metab_wincorr=est_bivariate_arima_model(metab,wincorr,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.metab_wincorr
vnames=c('metab','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

####metabolism vs. within-network connectivity (full set of metabolites)
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fullmetab_wincorr=est_bivariate_arima_model(fullmetab,wincorr,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.fullmetab_wincorr
vnames=c('fullmetab','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```



#### within-network connectivity 
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wincorr_wincorr=est_bivariate_arima_model(wincorr,wincorr,skip_ident=TRUE)
```

```{r  results="asis"}
d=out.dat.wincorr_wincorr
vnames=c('wincorr','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```



#### food vs. within-network connectivity
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.food_wincorr=est_bivariate_arima_model(food,wincorr)
```

```{r  results="asis"}
d=out.dat.food_wincorr
vnames=c('food','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### food vs. behavior
Remove food variables that have too many zeros or ones, otherwise will fail

```{r message=FALSE,warning=FALSE,error=FALSE}
food$apples=NULL  
food$blueberries=NULL
behav_keep_no_tth$zeo.zq=NULL

out.dat.food_behav=est_bivariate_arima_model(food,behav_keep_no_tth)
```

```{r  results="asis"}
d=out.dat.food_behav
vnames=c('food','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### compare head motion to other measures
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.behav=est_bivariate_arima_model(fd,behav_keep)
```

```{r  results="asis"}
d=out.dat.fd_behav
vnames=c('fd','behav')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.rnaseq=est_bivariate_arima_model(fd,rnaseq_wgcna,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.fd_rnaseq
vnames=c('fd','wgcna')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.metab=est_bivariate_arima_model(fd,metab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.fd_metab
vnames=c('fd','metab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.fd.wincorr=est_bivariate_arima_model(fd,wincorr)
```

```{r  results="asis"}
d=out.dat.fd_wincorr
vnames=c('fd','wincorr')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```


#### RNA-seq 


```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_wgcna=est_bivariate_arima_model(rnaseq_wgcna, rnaseq_wgcna,spacing='1 week',skip_ident=TRUE)
```

```{r  results="asis"}
d=out.dat.wgcna_wgcna
vnames=c('wgcna','wgcna')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### RNA-seq vs. metabolism
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_metab=est_bivariate_arima_model(rnaseq_wgcna,metab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.wgcna_metab
vnames=c('wgcna','metab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

#### RNA-seq vs. metabolism (full set)
```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_fullmetab=est_bivariate_arima_model(rnaseq_wgcna,fullmetab,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.wgcna_fullmetab
vnames=c('wgcna','fullmetab')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```


#### RNA-seq vs. food


```{r message=FALSE,warning=FALSE,error=FALSE}

out.dat.wgcna_food=est_bivariate_arima_model(food,rnaseq_wgcna,spacing='1 week')
```

```{r  results="asis"}
d=out.dat.wgcna_food
vnames=c('wgcna','food')

kable_wrap(d)
output_results(d,vnames,OUTPUT_DIR=OUTPUT_DIR)

```

